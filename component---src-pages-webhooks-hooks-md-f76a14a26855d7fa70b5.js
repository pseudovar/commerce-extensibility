"use strict";(self.webpackChunkcommerce_extensibility=self.webpackChunkcommerce_extensibility||[]).push([[3017],{74853:function(e,t,n){n.r(t),n.d(t,{_frontmatter:function(){return i},default:function(){return p}});var a=n(87462),o=n(45987),r=(n(35776),n(3905)),d=n(91515);const l=["components"],i={},m={_frontmatter:i},s=d.Z;function p(e){let{components:t}=e,n=(0,o.Z)(e,l);return(0,r.mdx)(s,(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,r.mdx)("h1",{id:"configure-hooks"},"Configure hooks"),(0,r.mdx)("p",null,"A hook defines a request to a remote server. The ",(0,r.mdx)("inlineCode",{parentName:"p"},"hook")," element of the ",(0,r.mdx)("inlineCode",{parentName:"p"},"webhooks.xml")," file describes the communication parameters, including the URL of the remote service to execute, HTTP method, and timeout information. Additional configuration occurs within the ",(0,r.mdx)("inlineCode",{parentName:"p"},"headers")," and ",(0,r.mdx)("inlineCode",{parentName:"p"},"fields")," elements. Each individual ",(0,r.mdx)("inlineCode",{parentName:"p"},"header")," element defines an HTTP header key/value pair, while the individual ",(0,r.mdx)("inlineCode",{parentName:"p"},"field")," elements define what data is transmitted to the external server."),(0,r.mdx)("p",null,"The ",(0,r.mdx)("a",{parentName:"p",href:"xml-schema.md"},"webhook configuration reference")," describes each element in detail."),(0,r.mdx)("h2",{id:"define-the-connection"},"Define the connection"),(0,r.mdx)("p",null,"The following hook definition includes the hook name, the destination URL, and timeout information. The ",(0,r.mdx)("inlineCode",{parentName:"p"},"fallbackErrorMessage")," will be written to the error log and can be displayed on the storefront."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-xml"},'<hook name="validate_stock" url="{env:APP_VALIDATE_STOCK_URL}/product-validate-stock"\ntimeout="2000" softTimeout="200" fallbackErrorMessage="Can\'t add the product to the cart right now">`\n')),(0,r.mdx)("p",null,"The hook URL is formed by concatenating the ",(0,r.mdx)("inlineCode",{parentName:"p"},"APP_VALIDATE_STOCK_URL")," environment variable and the partial path ",(0,r.mdx)("inlineCode",{parentName:"p"},"/product-validate-stock"),". This practice is useful for developing in different environments, such as those for staging and production, where the hook URLs are different."),(0,r.mdx)("h2",{id:"define-request-headers"},"Define request headers"),(0,r.mdx)("p",null,"You will typically need to send authorization tokens and other connection parameters in the headers of your remote request. Secrets and other sensitive data should not be stored in the ",(0,r.mdx)("inlineCode",{parentName:"p"},"webhooks.xml")," file. Instead, use environment or configuration variables to relay this information."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-xml"},'<hook name="validate_stock" url="{env:APP_VALIDATE_STOCK_URL}/product-validate-stock" timeout="2000" softTimeout="200" required="true" fallbackErrorMessage="Can\'t add the product to the cart right now">\n    <headers>\n        <header name="Authorization">Bearer: {env:APP_VALIDATE_STOCK_AUTHORIZATION_TOKEN}</header>\n        <header name="api-key">{config:path/to/api-key}</header>\n    </headers>\n</hook>\n')),(0,r.mdx)("p",null,"This example defines two headers:"),(0,r.mdx)("table",null,(0,r.mdx)("thead",{parentName:"table"},(0,r.mdx)("tr",{parentName:"thead"},(0,r.mdx)("th",{parentName:"tr",align:null},"Name"),(0,r.mdx)("th",{parentName:"tr",align:null},"Value"))),(0,r.mdx)("tbody",{parentName:"table"},(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"Authorization")),(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"Bearer:")," and the value of the ",(0,r.mdx)("inlineCode",{parentName:"td"},"APP_VALIDATE_STOCK_AUTHORIZATION_TOKEN")," environment variable.")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"api-key")),(0,r.mdx)("td",{parentName:"tr",align:null},"Value from the Adobe Commerce configuration to the file containing the key (",(0,r.mdx)("inlineCode",{parentName:"td"},"path/to/api-key"),").")))),(0,r.mdx)("h3",{id:"dynamic-header-resolvers"},"Dynamic header resolvers"),(0,r.mdx)("p",null,"Instead of storing secrets that expire in environment variables, you can create a dynamic header resolver to manage these values. To create your own resolver, define a new class that implements ",(0,r.mdx)("inlineCode",{parentName:"p"},"Magento\\AdobeCommerceWebhooks\\Model\\HeaderResolverInterface"),", as shown below."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-php"},"<?php\ndeclare(strict_types=1);\n \nnamespace Magento\\WebhookModule\\Model;\n\n...\n \nclass AddProductToCartResolver implements HeaderResolverInterface\n{\n    public function __construct(\n        private TokenGenerator $tokenGenerator,\n        private CustomConfig $customConfig,\n    ) {\n    }\n \n    /**\n     *  Returns an array of custom headers\n     * \n     * @return array\n     */\n    public function getHeaders(): array\n    {\n        return [\n            'Authorization' => 'Bearer ' . $this->tokenGenerator->getToken(),\n            'Api-key' => $this->customConfig->getApiKey(),\n            'secret-key' => $this->customConfig->getSecretKey(),\n        ];    \n    }\n}\n")),(0,r.mdx)("p",null,"Point to the ",(0,r.mdx)("inlineCode",{parentName:"p"},"AddProductToCartResolver")," class in the ",(0,r.mdx)("inlineCode",{parentName:"p"},"header.resolver")," attribute."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-xml"},'<hook name="validate_stock" url="{env:APP_VALIDATE_STOCK_URL}/product-validate-stock" timeout="2000" softTimeout="200" required="true" fallbackErrorMessage="Can\'t add the product to the cart right now">\n    <headers>\n        <header resolver="Magento\\WebhookModule\\Model\\AddProductToCartResolver" />\n    </headers>\n</hook>\n')),(0,r.mdx)("h2",{id:"define-the-hook-body"},"Define the hook body"),(0,r.mdx)("p",null,"The payload for a hook can be large, but in many cases you only need to transmit a few fields to perform the desired operation on the remote server."),(0,r.mdx)("p",null,"Defining the hook requires knowledge of the structure of the original event and the requirements of the remote call. You can use the ",(0,r.mdx)("inlineCode",{parentName:"p"},"bin/magento [webhooks:info](commands.md#display-the-payload-of-a-webhook) <webhook-name>")," command to return the default payload of a webhook."),(0,r.mdx)("p",null,"Imagine that the command returned a Commerce webhook with the following structure:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-json"},'{\n    "data": {\n        "product": {\n            "name": "string",\n            "sku": "string",\n            "qty": "float"\n        }\n    }\n}\n')),(0,r.mdx)("p",null,"The webhook contains a top-level ",(0,r.mdx)("inlineCode",{parentName:"p"},"data")," object, and a second-level ",(0,r.mdx)("inlineCode",{parentName:"p"},"product")," object with several fields. However, your remote application expects a payload with the following structure:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-json"},'{\n    "product": {\n        "name": "string",\n        "sku": "string",\n        "quantity": "float"\n    }\n}\n')),(0,r.mdx)("p",null,"To transmit this object to the remote application, you will need to remove the ",(0,r.mdx)("inlineCode",{parentName:"p"},"data")," object from the payload and rename ",(0,r.mdx)("inlineCode",{parentName:"p"},"qty")," to ",(0,r.mdx)("inlineCode",{parentName:"p"},"quantity"),". The ",(0,r.mdx)("inlineCode",{parentName:"p"},"source")," configuration attribute specifies the full path of a Commerce webhook field, while the ",(0,r.mdx)("inlineCode",{parentName:"p"},"name")," attribute defines the full path of the field to transmit. If the two values are identical, then you can omit the ",(0,r.mdx)("inlineCode",{parentName:"p"},"source")," attribute."),(0,r.mdx)("p",null,"The following example configures the webhook described above."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-xml"},"<hook name=\"validate_stock\" url=\"https://example.com/product-validate-stock\" timeout=\"2000\" softTimeout=\"200\" required=\"true\" fallbackErrorMessage=\"Can't add the product to the cart right now\">\n    <fields>\n        <field name='product.name' source='data.product.name' />\n        <field name='product.sku' source='data.product.sku' />\n        <field name='product.quantity' source='data.product.qty' />\n    </fields>\n</hook>\n")),(0,r.mdx)("p",null,"If the default payload of a webhook contains an array of objects, use the following construction to select fields from that array:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-text"},"<object_name>[].<field_name>\n")),(0,r.mdx)("p",null,"For example, the payload of the ",(0,r.mdx)("inlineCode",{parentName:"p"},"plugin.magento.quote.api.shipment_estimation.estimate_by_extended_address")," event contains a top-level ",(0,r.mdx)("inlineCode",{parentName:"p"},"results[]")," array. The array contains details about two individual shipping estimates."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-json"},'{\n    "subject": [],\n    "result": [\n        {\n            "carrier_code": "tablerate",\n            "method_code": "bestway",\n            "carrier_title": "Best Way",\n            "method_title": "Table Rate",\n            "amount": 15,\n            "base_amount": 15,\n            "available": true,\n            "error_message": "",\n            "price_excl_tax": 15,\n            "price_incl_tax": 15\n        },\n        {\n            "carrier_code": "flatrate",\n            "method_code": "flatrate",\n            "carrier_title": "Flat Rate",\n            "method_title": "Fixed",\n            "amount": 20,\n            "base_amount": 20,\n            "available": true,\n            "error_message": "",\n            "price_excl_tax": 20,\n            "price_incl_tax": 20\n        }\n    ],\n    "cartId": "21",\n    "address": {\n        "street": "123 Test Road",\n        "city": "Test City",\n        "region_id": 12,\n        "region": "California",\n        "country_id": "US",\n        "postcode": "90000",\n        "firstname": "Test",\n        "lastname": "Test",\n        "company": "",\n        "telephone": "1800000000",\n        "save_in_address_book": 1,\n        "region_code": "CA",\n        "extension_attributes": []\n    }\n}\n')),(0,r.mdx)("p",null,"To transmit the ",(0,r.mdx)("inlineCode",{parentName:"p"},"postcode")," property of the ",(0,r.mdx)("inlineCode",{parentName:"p"},"address")," object and the ",(0,r.mdx)("inlineCode",{parentName:"p"},"carrier_code"),", ",(0,r.mdx)("inlineCode",{parentName:"p"},"method_code"),", and ",(0,r.mdx)("inlineCode",{parentName:"p"},"base_amount")," for each shipping estimate, configure the webhook's fields as follows:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-xml"},"<fields>\n    <field name='postcode' source='address.postcode' />\n    <field name='result[].carrier_code' />\n    <field name='result[].method_code' />\n    <field name='result[].base_amount' />\n</fields>\n")),(0,r.mdx)("p",null,"Commerce sends the following object to the remote application:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-json"},'{\n    "postcode": "90000",\n    "result": [\n        {\n            "carrier_code": "tablerate",\n            "method_code": "bestway",\n            "base_amount": 15\n        },\n        {\n            "carrier_code": "flatrate",\n            "method_code": "flatrate",\n            "base_amount": 20\n        }\n    ]\n}\n')),(0,r.mdx)("h3",{id:"field-converters"},"Field converters"),(0,r.mdx)("p",null,"You can implement a converter class to convert a field to a different data type. For example, Commerce stores order IDs as numeric values. If the hook endpoint expects order IDs to be text values, you must convert the numeric value to a string representation before sending the payload."),(0,r.mdx)("p",null,"All converter classes must implement ",(0,r.mdx)("inlineCode",{parentName:"p"},"Magento\\AdobeCommerceWebhooks\\Model\\Filter\\Converter\\FieldConverterInterface"),". The ",(0,r.mdx)("inlineCode",{parentName:"p"},"toExternalFormat")," method of a converter class converts a field value before sending a request to the hook endpoint."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-xml"},"<fields>\n    <field name='order.id' source='data.order.id' />\n    <field name='order.status' source='data.order.status' converter=\"Path/To/The/Converter/Class\" />\n</fields>\n")),(0,r.mdx)("p",null,"A converter class can also convert the value in a hook endpoint response object that has an operation status of  ",(0,r.mdx)("inlineCode",{parentName:"p"},"replace"),". A value in a ",(0,r.mdx)("inlineCode",{parentName:"p"},"replace")," response object will be converted only if the path in the object corresponds to the source of a field with a configured converter class."),(0,r.mdx)("p",null,"For example, given the above hook field configuration, conversion occurs only if a ",(0,r.mdx)("inlineCode",{parentName:"p"},"replace")," response object specifies a path of ",(0,r.mdx)("inlineCode",{parentName:"p"},"data/order/status"),". In this case, the ",(0,r.mdx)("inlineCode",{parentName:"p"},"fromExternalFormat")," method of the configured converter class will be called to convert the value in the response object."),(0,r.mdx)("h3",{id:"context-fields"},"Context fields"),(0,r.mdx)("p",null,"You can add to the webhook payload values from the application context:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-xml"},'<fields>\n    <field name="customer.entity_id" source="data.customer.entity_id" />\n    <field name="customer.customer_email" source="context_customer_session.get_customer.get_email" />\n</fields>\n')),(0,r.mdx)("p",null,"In this example, the value of ",(0,r.mdx)("inlineCode",{parentName:"p"},"customer.customer_email")," will be set to ",(0,r.mdx)("inlineCode",{parentName:"p"},"Magento\\Customer\\Model\\Session::getCustomer()::getEmail()"),". If the value does not exist or cannot be processed, the appropriate message will be logged, and the hook execution will not be interrupted."),(0,r.mdx)("p",null,"You can also specify the string arguments to use when accessing the application context. Provide these arguments within curly braces and delimit multiple arguments with colons, if applicable. The following example sets ",(0,r.mdx)("inlineCode",{parentName:"p"},"config_value")," to the value of ",(0,r.mdx)("inlineCode",{parentName:"p"},"Magento\\Framework\\App\\Config\\ScopeConfigInterface::getValue('value/path', 'default')"),"."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-xml"},'<fields>\n    <field name="config_value" source="context_scope_config.get_value{value/path:default}" />\n</fields>\n')),(0,r.mdx)("p",null,"Supported contexts:"),(0,r.mdx)("table",null,(0,r.mdx)("thead",{parentName:"table"},(0,r.mdx)("tr",{parentName:"thead"},(0,r.mdx)("th",{parentName:"tr",align:null},"Context"),(0,r.mdx)("th",{parentName:"tr",align:null},"Context class"))),(0,r.mdx)("tbody",{parentName:"table"},(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"context_checkout_session")),(0,r.mdx)("td",{parentName:"tr",align:null},"Magento\\Checkout\\Model\\Session")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"context_customer_session")),(0,r.mdx)("td",{parentName:"tr",align:null},"Magento\\Customer\\Model\\Session")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"context_registry")),(0,r.mdx)("td",{parentName:"tr",align:null},"Magento\\Framework\\Registry")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"context_application_state")),(0,r.mdx)("td",{parentName:"tr",align:null},"Magento\\Framework\\App\\State")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"context_scope_config")),(0,r.mdx)("td",{parentName:"tr",align:null},"Magento\\Framework\\App\\Config\\ScopeConfigInterface")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"context_http_request")),(0,r.mdx)("td",{parentName:"tr",align:null},"Magento\\Framework\\App\\Request\\Http")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"context_staging")),(0,r.mdx)("td",{parentName:"tr",align:null},"Magento\\Staging\\Model\\VersionManager")))),(0,r.mdx)("h2",{id:"clean-the-cache"},"Clean the cache"),(0,r.mdx)("p",null,"If you are adding webhook functionality to an instance that is in production mode, run the following command to clean the cache and make the webhook available to the system:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-bash"},"bin/magento cache:clean config\n")),(0,r.mdx)("p",null,"If the instance is in developer mode, these configuration changes are detected automatically."))}p.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-webhooks-hooks-md-f76a14a26855d7fa70b5.js.map